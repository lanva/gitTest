<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sekorm.core.dao.promotion.ElecPromotionDetailMapper" >
  <resultMap id="BaseResultMap" type="com.sekorm.core.model.promotion.ElecPromotionDetail" >
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="batch_id" property="batchId" jdbcType="INTEGER" />
    <result column="pn_code" property="pnCode" jdbcType="VARCHAR" />
    <result column="brand_name" property="brandName" jdbcType="VARCHAR" />
    <result column="category" property="category" jdbcType="VARCHAR" />
    <result column="stock_balance" property="stockBalance" jdbcType="INTEGER" />
  </resultMap>
  <sql id="Base_Column_List" >
    id, batch_id, pn_code, brand_name, category, stock_balance
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    select 
    <include refid="Base_Column_List" />
    from t_elec_promotion_detail
    where id = #{id,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    delete from t_elec_promotion_detail
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.sekorm.core.model.promotion.ElecPromotionDetail" useGeneratedKeys="true" keyProperty="id">
    insert into t_elec_promotion_detail (id, batch_id, pn_code, 
      brand_name, category, stock_balance
      )
    values (#{id,jdbcType=INTEGER}, #{batchId,jdbcType=INTEGER}, #{pnCode,jdbcType=VARCHAR}, 
      #{brandName,jdbcType=VARCHAR}, #{category,jdbcType=VARCHAR}, #{stockBalance,jdbcType=INTEGER}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.sekorm.core.model.promotion.ElecPromotionDetail" useGeneratedKeys="true" keyProperty="id">
    insert into t_elec_promotion_detail
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="batchId != null" >
        batch_id,
      </if>
      <if test="pnCode != null" >
        pn_code,
      </if>
      <if test="brandName != null" >
        brand_name,
      </if>
      <if test="category != null" >
        category,
      </if>
      <if test="stockBalance != null" >
        stock_balance,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=INTEGER},
      </if>
      <if test="batchId != null" >
        #{batchId,jdbcType=INTEGER},
      </if>
      <if test="pnCode != null" >
        #{pnCode,jdbcType=VARCHAR},
      </if>
      <if test="brandName != null" >
        #{brandName,jdbcType=VARCHAR},
      </if>
      <if test="category != null" >
        #{category,jdbcType=VARCHAR},
      </if>
      <if test="stockBalance != null" >
        #{stockBalance,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.sekorm.core.model.promotion.ElecPromotionDetail" >
    update t_elec_promotion_detail
    <set >
      <if test="batchId != null" >
        batch_id = #{batchId,jdbcType=INTEGER},
      </if>
      <if test="pnCode != null" >
        pn_code = #{pnCode,jdbcType=VARCHAR},
      </if>
      <if test="brandName != null" >
        brand_name = #{brandName,jdbcType=VARCHAR},
      </if>
      <if test="category != null" >
        category = #{category,jdbcType=VARCHAR},
      </if>
      <if test="stockBalance != null" >
        stock_balance = #{stockBalance,jdbcType=INTEGER},
      </if>
    </set>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.sekorm.core.model.promotion.ElecPromotionDetail" >
    update t_elec_promotion_detail
    set batch_id = #{batchId,jdbcType=INTEGER},
      pn_code = #{pnCode,jdbcType=VARCHAR},
      brand_name = #{brandName,jdbcType=VARCHAR},
      category = #{category,jdbcType=VARCHAR},
      stock_balance = #{stockBalance,jdbcType=INTEGER}
    where id = #{id,jdbcType=INTEGER}
  </update>

	<!-- 查询所有可以展示的促销信息 -->
	<select id="listAll" resultMap="BaseResultMap" >
		select 
		id, pn_code, brand_name, category, IF(stock_balance > 99, 2, 1) stock_balance
		from t_elec_promotion_detail
		where batch_id in (select id from t_elec_promotion where `status` = 1)
		and stock_balance > 0
	</select>
	
	<!-- 分页查询可以展示的促销信息 -->
	<select id="pageList" resultMap="BaseResultMap" >
		select 
		id, pn_code, brand_name, category, IF(stock_balance > 99, 2, 1) stock_balance
		from t_elec_promotion_detail
		where batch_id in (select id from t_elec_promotion where `status` = 1)
		and stock_balance > 0
	</select>
	
	<!-- 查询某一型号的库存量 -->
	<select id="getStockByPnCode" resultMap="BaseResultMap" >
		SELECT 
		id, stock_balance
		FROM t_elec_promotion_detail
		WHERE batch_id IN (SELECT id FROM t_elec_promotion WHERE `status` = 1)
		AND pn_code = #{pnCode,jdbcType=VARCHAR}
		LIMIT 1
	</select>
	
	<!-- 型号联想查询, 右模糊查询 -->
	<select id="associationPnCode" resultType="java.lang.String" >
		SELECT 
		pn_code
		FROM t_elec_promotion_detail
		WHERE batch_id IN (SELECT id FROM t_elec_promotion WHERE `status` = 1)
		AND pn_code LIKE CONCAT(#{pnCode,jdbcType=VARCHAR}, '%')
		LIMIT 10
	</select>

	<select id="selectByBatch" resultMap="BaseResultMap" >
    select 
    epd.*
    from t_elec_promotion ep
	inner join t_elec_promotion_detail epd on ep.id = epd.batch_id
    where 1 = 1
    <if test="record != null and record.status != null ">
		and ep.status = #{record.status ,jdbcType=INTEGER}
	</if>
	<if test="record != null and record.batchId != null ">
		and ep.id = #{record.batchId, jdbcType=INTEGER}
	</if>
	order by epd.id asc
	<if test="page !=null and pagesize != null">
		limit #{page}, #{pagesize} 
	</if>
  </select>
  
  <select id="selectByBatchCount" resultType="java.lang.Integer" >
    select 
    count(1)
    from t_elec_promotion ep
	inner join t_elec_promotion_detail epd on ep.id = epd.batch_id
    where 1 = 1
    <if test="record != null and record.status != null ">
		and ep.status = #{record.status ,jdbcType=INTEGER}
	</if>
	<if test="record != null and record.batchId != null ">
		and ep.id = #{record.batchId, jdbcType=INTEGER}
	</if>
  </select>
</mapper>